version: "3.9"

services:
  db:
    image: mysql:8.0
    container_name: wheats-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: wheats
      MYSQL_USER: wheats
      MYSQL_PASSWORD: wheats
    volumes:
      # ✅ 도커 네임드 볼륨 사용 (권한 문제 해결)
      - wheats-mysql-data:/var/lib/mysql

      # ✅ 초기 스키마 & 데이터 스크립트는 그대로 유지
      - ../db/schema.sql:/docker-entrypoint-initdb.d/1_schema.sql
      - ../db/init.sql:/docker-entrypoint-initdb.d/2_init.sql
    ports:
      - "3307:3306"   # 로컬에서 접속할 때 3307 포트 사용
    networks:
      - wheats-net

  api:
    build:
      context: ../api
      dockerfile: ../docker/api/Dockerfile
    container_name: wheats-api
    depends_on:
      - db
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: wheats
      DB_USER: wheats
      DB_PASSWORD: wheats
    ports:
      - "9000:9000"    # 예시: API 서버 외부 포트
    networks:
      - wheats-net

  oauth-server:
    build:
      context: ../oauth-server
      dockerfile: ../docker/oauth-server/Dockerfile
    container_name: wheats-oauth
    depends_on:
      - db
    environment:
      OAUTH_DB_HOST: db
      OAUTH_DB_PORT: 3306
      OAUTH_DB_NAME: wheats
      OAUTH_DB_USER: wheats
      OAUTH_DB_PASSWORD: wheats
    ports:
      - "9100:9100"
    networks:
      - wheats-net

  web:
    build:
      context: ../web
      dockerfile: ../docker/web/Dockerfile
    container_name: wheats-web
    depends_on:
      - api
      - oauth-server
    ports:
      - "8080:80"   # 예: 웹 프론트가 nginx로 80을 쓰는 구조라고 가정
    networks:
      - wheats-net

networks:
  wheats-net:
    driver: bridge

# ✅ MySQL 데이터용 네임드 볼륨 정의
volumes:
  wheats-mysql-data:
